<Window x:Class="AIStudio.Dialogs.ReflexChainBindingDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:converters="clr-namespace:AIStudio.Converters"
        mc:Ignorable="d" 
        Title="Управление цепочками рефлексов" 
        Height="700" 
        Width="1100"
        WindowStartupLocation="CenterOwner"
        MinHeight="600" MinWidth="900"
        WindowState="Maximized">

  <Window.Resources>
    <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
    <converters:Level1ToTextConverter x:Key="Level1ToTextConverter"/>
    <converters:IdListToNamesConverter x:Key="IdListToNamesConverter"/>
    <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

    <!-- Стили для таблиц -->
    <Style x:Key="DataGridBaseStyle" TargetType="DataGrid">
      <Setter Property="Background" Value="White"/>
      <Setter Property="RowBackground" Value="#FFF9F9F9"/>
      <Setter Property="AlternatingRowBackground" Value="#FFF0F0F0"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="GridLinesVisibility" Value="None"/>
      <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
      <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
      <Setter Property="SelectionUnit" Value="FullRow"/>
      <Setter Property="CanUserAddRows" Value="False"/>
      <Setter Property="CanUserDeleteRows" Value="False"/>
      <Setter Property="AutoGenerateColumns" Value="False"/>
      <Setter Property="IsReadOnly" Value="True"/>
    </Style>

    <Style x:Key="HighlightedRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <Trigger Property="IsSelected" Value="True">
          <Setter Property="Background" Value="#FFE3F2FD"/>
          <Setter Property="BorderBrush" Value="#FF2196F3"/>
          <Setter Property="BorderThickness" Value="1"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Foreground" Value="#FF333333"/>
    </Style>

    <Style x:Key="FilterLabelStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="Margin" Value="0,0,5,0"/>
    </Style>

    <!-- Стиль для кнопок действий -->
    <Style x:Key="ActionButtonStyle" TargetType="Button">
      <Setter Property="Width" Value="140"/>
      <Setter Property="Height" Value="32"/>
      <Setter Property="Margin" Value="0,0,10,0"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Cursor" Value="Hand"/>
    </Style>

  </Window.Resources>

  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Заголовок и информация о рефлексе -->
    <Border Grid.Row="0" 
            Background="#FF2196F3" 
            CornerRadius="4"
            Margin="0,0,0,10"
            Padding="12">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <TextBlock Grid.Column="0"
                   Text="УПРАВЛЕНИЕ ЦЕПОЧКАМИ РЕФЛЕКСОВ" 
                   FontSize="20"
                   FontWeight="Bold"
                   HorizontalAlignment="Left"
                   Foreground="White"/>

        <TextBlock Grid.Column="1"
                   Text="{Binding ReflexInfo}"
                   FontSize="14"
                   FontWeight="SemiBold"
                   HorizontalAlignment="Right"
                   Foreground="White"
                   VerticalAlignment="Center"/>
      </Grid>
    </Border>

    <!-- Панель фильтров для цепочек -->
    <Border Grid.Row="1" 
            BorderBrush="#FFBBDEFB" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,10"
            Padding="10"
            Background="#FFE3F2FD">
      <StackPanel>
        <TextBlock Text="Фильтры цепочек:" 
                   Style="{StaticResource HeaderTextStyle}"
                   Foreground="#FF0D47A1"
                   Margin="0,0,0,8"/>

        <StackPanel Orientation="Horizontal">
          <!-- Фильтр по ID -->
          <StackPanel Orientation="Vertical" Margin="0,0,15,0" Width="120">
            <TextBlock Text="ID" Style="{StaticResource FilterLabelStyle}"/>
            <TextBox Text="{Binding ChainIdFilter, UpdateSourceTrigger=PropertyChanged, Delay=300}"
             Height="25"
             FontSize="12"
             BorderBrush="#FF90CAF9"
             Padding="4"
             ToolTip="Контекстный поиск по части ID"/>
          </StackPanel>

          <!-- Фильтр по названию -->
          <StackPanel Orientation="Vertical" Margin="0,0,15,0" Width="200">
            <TextBlock Text="Название" Style="{StaticResource FilterLabelStyle}"/>
            <TextBox Text="{Binding ChainNameFilter, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                 Height="25"
                 FontSize="12"
                 BorderBrush="#FF90CAF9"
                 Padding="4"
                 ToolTip="Контекстный поиск по части названия"/>
          </StackPanel>

          <!-- Фильтр по наличию привязки -->
          <StackPanel Orientation="Vertical" Margin="0,0,15,0" Width="150">
            <TextBlock Text="Привязка" Style="{StaticResource FilterLabelStyle}"/>
            <ComboBox ItemsSource="{Binding BindingFilterOptions}"
                  SelectedValue="{Binding SelectedBindingFilter}"
                  DisplayMemberPath="Value"
                  SelectedValuePath="Key"
                  Height="25"
                  FontSize="12"/>
          </StackPanel>

          <!-- Кнопка сброса фильтров -->
          <Button Content="Сбросить фильтры" 
            Command="{Binding ClearFiltersCommand}"
            Width="120"
            Height="30"
            Margin="20,5,0,0"
            Background="#FFF5F5F5"
            BorderBrush="#FF9E9E9E"
            Foreground="#FF333333"
            FontSize="12"/>
        </StackPanel>

      </StackPanel>
    </Border>

    <!-- Список цепочек -->
    <Grid Grid.Row="2" Margin="0,0,0,10">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Заголовок списка цепочек -->
      <Border Grid.Row="0" 
              Background="#FFE8EAF6" 
              BorderBrush="#FFC5CAE9" 
              BorderThickness="1,1,1,0"
              CornerRadius="4,4,0,0"
              Padding="10">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <TextBlock Grid.Column="0"
                     Text="ЦЕПОЧКИ РЕФЛЕКСОВ" 
                     FontWeight="Bold"
                     FontSize="16"
                     Foreground="#FF3F51B5"/>

          <TextBlock Grid.Column="1"
                     Text="{Binding ChainsInfo}"
                     FontSize="12"
                     FontStyle="Italic"
                     HorizontalAlignment="Right"
                     Foreground="#FF666666"
                     Margin="0,0,10,0"/>

          <TextBlock Grid.Column="2"
                     Text="{Binding ChainsCount, StringFormat='Всего: {0}'}"
                     FontSize="13"
                     FontWeight="SemiBold"
                     Foreground="#FF2196F3"/>
        </Grid>
      </Border>

      <!-- Таблица цепочек -->
      <Border Grid.Row="1" 
              BorderBrush="#FFC5CAE9" 
              BorderThickness="1,0,1,1"
              CornerRadius="0,0,4,4">
        <DataGrid x:Name="ChainsDataGrid"
                  ItemsSource="{Binding FilteredChains}"
                  SelectedItem="{Binding SelectedChain, Mode=TwoWay}"
                  Style="{StaticResource DataGridBaseStyle}"
                  SelectionMode="Single"
                  RowStyle="{StaticResource HighlightedRowStyle}"
                  SelectionChanged="ChainsDataGrid_SelectionChanged">

          <DataGrid.Columns>
            <DataGridTextColumn Header="ID" Binding="{Binding ID}" Width="60">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="200">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="TextWrapping" Value="Wrap"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="*">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="TextWrapping" Value="Wrap"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Звеньев" Binding="{Binding Links.Count}" Width="70">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

          </DataGrid.Columns>
        </DataGrid>
      </Border>
    </Grid>

    <!-- Список звеньев выбранной цепочки -->
    <Grid Grid.Row="3" Margin="0,0,0,10">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Заголовок списка звеньев -->
      <Border Grid.Row="0" 
              Background="#FFE8F5E8" 
              BorderBrush="#FFC8E6C9" 
              BorderThickness="1,1,1,0"
              CornerRadius="4,4,0,0"
              Padding="10">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <TextBlock Grid.Column="0"
                     Text="ЗВЕНЬЯ ВЫБРАННОЙ ЦЕПОЧКИ" 
                     FontWeight="Bold"
                     FontSize="16"
                     Foreground="#FF4CAF50"/>

          <TextBlock Grid.Column="1"
                     Text="{Binding SelectedChainInfo}"
                     FontSize="12"
                     FontStyle="Italic"
                     HorizontalAlignment="Right"
                     Foreground="#FF666666"
                     Margin="0,0,10,0"/>

          <TextBlock Grid.Column="2"
                     Text="{Binding LinksCount, StringFormat='Звеньев: {0}'}"
                     FontSize="13"
                     FontWeight="SemiBold"
                     Foreground="#FF4CAF50"/>
        </Grid>
      </Border>

      <!-- Таблица звеньев -->
      <Border Grid.Row="1" 
              BorderBrush="#FFC8E6C9" 
              BorderThickness="1,0,1,1"
              CornerRadius="0,0,4,4">
        <DataGrid x:Name="LinksDataGrid"
                  ItemsSource="{Binding SelectedChainLinks}"
                  Style="{StaticResource DataGridBaseStyle}"
                  SelectionMode="Single">

          <DataGrid.Columns>
            <DataGridTextColumn Header="ID" Binding="{Binding ID}" Width="60">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Действие" Binding="{Binding ActionId}" Width="80">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Следующее (успех)" Binding="{Binding SuccessNextLink}" Width="110">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Следующее (неудача)" Binding="{Binding FailureNextLink}" Width="110">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="*">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontWeight" Value="SemiBold"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="TextWrapping" Value="Wrap"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
          </DataGrid.Columns>
        </DataGrid>
      </Border>
    </Grid>

    <!-- Панель управления -->
    <Border Grid.Row="4" 
            BorderBrush="#FFFFF3E0" 
            BorderThickness="1"
            CornerRadius="4"
            Padding="12"
            Background="#FFFFF8E1">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Информация о выборе -->
        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center">
          <TextBlock Text="{Binding SelectionInfo}"
                     FontSize="13"
                     FontStyle="Italic"
                     Foreground="#FF333333"/>

          <TextBlock Text="{Binding CurrentBindingInfo}"
           FontSize="13"
           FontStyle="Italic"
           Foreground="#FF4CAF50"
           Margin="0,3,0,0"
           Visibility="{Binding HasCurrentBinding, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        </StackPanel>

        <!-- Кнопка редактирования -->
        <Button Grid.Column="1"
                Content="✏️ Редактировать" 
                Click="EditChainButton_Click"
                Style="{StaticResource ActionButtonStyle}"
                ToolTip="Открыть редактор выбранной цепочки"
                Background="#FFFF9800"
                BorderBrush="#FFF57C00"
                Foreground="White"
                IsEnabled="{Binding IsChainSelected}"/>

        <!-- Кнопка удаления -->
        <Button Grid.Column="2"
                Content="🗑️ Удалить" 
                Click="DeleteChainButton_Click"
                Style="{StaticResource ActionButtonStyle}"
                ToolTip="Удалить выбранную цепочку и все ее звенья"
                Background="#FFF44336"
                BorderBrush="#FFD32F2F"
                Foreground="White"
                Margin="0,0,15,0"
                IsEnabled="{Binding IsChainSelected}"/>

        <!-- Кнопка привязки -->
        <Button Grid.Column="3"
                Content="🔗 Привязать" 
                Click="BindChainButton_Click"
                Style="{StaticResource ActionButtonStyle}"
                ToolTip="Привязать выбранную цепочку к текущему рефлексу"
                Background="#FF4CAF50"
                BorderBrush="#FF388E3C"
                Foreground="White"
                Margin="0,0,15,0"
                IsEnabled="{Binding IsChainSelected}"/>

        <!-- Кнопка отмены -->
        <Button Grid.Column="4"
                Content="❌ Закрыть" 
                Click="CloseButton_Click"
                Width="100"
                Height="32"
                Background="#FFF5F5F5"
                BorderBrush="#FF9E9E9E"
                Foreground="#FF333333"
                FontSize="13"
                Cursor="Hand"/>
      </Grid>
    </Border>
  </Grid>
</Window>
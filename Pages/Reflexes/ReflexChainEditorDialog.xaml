<Window x:Class="AIStudio.Dialogs.ReflexChainEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:converters="clr-namespace:AIStudio.Converters"
        mc:Ignorable="d" 
        Title="Редактор цепочек рефлексов" 
        Height="680" 
        Width="900"
        WindowStartupLocation="CenterOwner"
        MinHeight="600" MinWidth="800"
        PreviewKeyDown="Window_PreviewKeyDown"
        WindowState="Maximized">

  <Window.Resources>
    <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
    <converters:Level1ToTextConverter x:Key="Level1ToTextConverter"/>
    <converters:IdListToNamesConverter x:Key="IdListToNamesConverter"/>

    <Style x:Key="LinkDataGridStyle" TargetType="DataGrid">
      <Setter Property="Background" Value="White"/>
      <Setter Property="RowBackground" Value="#FFF9F9F9"/>
      <Setter Property="AlternatingRowBackground" Value="#FFF0F0F0"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="GridLinesVisibility" Value="None"/>
      <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
      <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
      <Setter Property="SelectionUnit" Value="FullRow"/>
      <Setter Property="CanUserAddRows" Value="False"/>
      <Setter Property="CanUserDeleteRows" Value="False"/>
      <Setter Property="CanUserSortColumns" Value="False"/>
    </Style>

    <Style x:Key="HighlightedRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <Trigger Property="IsSelected" Value="True">
          <Setter Property="Background" Value="#FFE3F2FD"/>
          <Setter Property="BorderBrush" Value="#FF2196F3"/>
          <Setter Property="BorderThickness" Value="1"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <Style x:Key="InfoTitleStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="14"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
    </Style>

    <Style x:Key="InfoValueStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="FontWeight" Value="Normal"/>
      <Setter Property="Margin" Value="5,0,0,0"/>
    </Style>

  </Window.Resources>

  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Заголовок -->
    <Border Grid.Row="0" 
            Background="#FF2196F3" 
            CornerRadius="4"
            Margin="0,0,0,10"
            Padding="12">
      <TextBlock Text="РЕДАКТОР ЦЕПОЧЕК РЕФЛЕКСОВ" 
                 FontSize="20"
                 FontWeight="Bold"
                 HorizontalAlignment="Center"
                 Foreground="White"/>
    </Border>
    
    <!-- Информация о рефлексе -->
    <Border Grid.Row="1" 
        BorderBrush="#FFBBDEFB" 
        BorderThickness="1"
        CornerRadius="4"
        Margin="0,0,0,10"
        Padding="10"
        Background="#FFE3F2FD">
      <StackPanel>
        <TextBlock Text="Информация о рефлексе:" 
               Style="{StaticResource InfoTitleStyle}"
               Foreground="#FF0D47A1"
               Margin="0,0,0,8"/>

        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
          </Grid.ColumnDefinitions>

          <!-- ID рефлекса -->
          <TextBlock Grid.Row="0" Grid.Column="0" 
                 Text="ID рефлекса:"
                 Style="{StaticResource InfoTitleStyle}"/>
          <TextBlock Grid.Row="0" Grid.Column="1" 
                 Text="{Binding ReflexId}"
                 Style="{StaticResource InfoValueStyle}"/>

          <!-- Базовое состояние -->
          <TextBlock Grid.Row="1" Grid.Column="0" 
                 Text="Базовое состояние:"
                 Style="{StaticResource InfoTitleStyle}"
                 Margin="0,5,0,0"/>
          <TextBlock Grid.Row="1" Grid.Column="1" 
                 Text="{Binding ReflexLevel1, Converter={StaticResource Level1ToTextConverter}}"
                 Style="{StaticResource InfoValueStyle}"
                 Margin="5,5,0,0"/>

          <!-- Стили реагирования -->
          <TextBlock Grid.Row="2" Grid.Column="0" 
                 Text="Стили реагирования:"
                 Style="{StaticResource InfoTitleStyle}"
                 Margin="0,5,0,0"/>
          <TextBlock Grid.Row="2" Grid.Column="1" 
                 Text="{Binding ReflexLevel2Text}"
                 Style="{StaticResource InfoValueStyle}"
                 Margin="5,5,0,0"
                 TextWrapping="Wrap"/>

          <!-- Внешние стимулы -->
          <TextBlock Grid.Row="3" Grid.Column="0" 
                 Text="Внешние стимулы:"
                 Style="{StaticResource InfoTitleStyle}"
                 Margin="0,5,0,0"/>
          <TextBlock Grid.Row="3" Grid.Column="1" 
                 Text="{Binding ReflexLevel3Text}"
                 Style="{StaticResource InfoValueStyle}"
                 Margin="5,5,0,0"
                 TextWrapping="Wrap"/>
        </Grid>
      </StackPanel>
    </Border>

    <!-- Реквизиты цепочки -->
    <Border Grid.Row="2" 
            BorderBrush="#FFC8E6C9" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,10"
            Padding="12"
            Background="#FFF1F8E9">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="250"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Название цепочки -->
        <TextBlock Grid.Row="0" Grid.Column="0" 
                   Text="Название:"
                   VerticalAlignment="Center"
                   Margin="0,0,10,5"
                   FontSize="14"
                   FontWeight="SemiBold"/>

        <TextBox Grid.Row="0" Grid.Column="1"
                 Text="{Binding ChainName, UpdateSourceTrigger=PropertyChanged}"
                 Height="30"
                 FontSize="13"
                 Margin="0,0,20,5"/>

        <!-- Описание -->
        <TextBlock Grid.Row="0" Grid.Column="2" 
                   Text="Описание:"
                   VerticalAlignment="Center"
                   Margin="0,0,10,5"
                   FontSize="14"
                   FontWeight="SemiBold"/>

        <TextBox Grid.Row="0" Grid.Column="3"
                 Text="{Binding ChainDescription}"
                 Height="30"
                 FontSize="13"
                 Margin="0,0,5,5"/>
      </Grid>
    </Border>

    <!-- Таблица звеньев -->
    <Border Grid.Row="3" 
            BorderBrush="#FFE0E0E0" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,5">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Заголовок таблицы звеньев -->
        <Border Grid.Row="0" 
                Background="#FFE8EAF6" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="0,0,0,1"
                Padding="10">
          <TextBlock Text="ЗВЕНЬЯ ЦЕПОЧКИ" 
                     FontWeight="Bold"
                     FontSize="16"
                     Foreground="#FF3F51B5"/>
        </Border>

        <!-- Таблица звеньев -->
        <DataGrid Grid.Row="1"
                  x:Name="LinksDataGrid"
                  ItemsSource="{Binding ChainLinks}"
                  SelectedItem="{Binding SelectedLink, Mode=TwoWay}"
                  Style="{StaticResource LinkDataGridStyle}"
                  AutoGenerateColumns="False"
                  SelectionMode="Single"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  RowStyle="{StaticResource HighlightedRowStyle}"
                  SelectionChanged="LinksDataGrid_SelectionChanged">

          <DataGrid.Columns>
            <DataGridTextColumn Header="ID" Binding="{Binding ID}" Width="50" IsReadOnly="True">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <!-- Действие -->
            <DataGridTemplateColumn Header="Действие" Width="220">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="Адаптивное действие для выполнения в этом звене"/>
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.ActionOptions, 
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                          SelectedValue="{Binding ActionId, UpdateSourceTrigger=PropertyChanged}"
                          DisplayMemberPath="Value"
                          SelectedValuePath="Key"
                          Height="26"
                          FontSize="12"
                          BorderBrush="#FF90CAF9"
                          Padding="2"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Следующее звено при успехе -->
            <DataGridTemplateColumn Header="Следующее (успех)" Width="220">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="ID следующего звена при успешном выполнении"/>
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.LinkOptions, 
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                          SelectedValue="{Binding SuccessNextLink, UpdateSourceTrigger=PropertyChanged}"
                          DisplayMemberPath="Value"
                          SelectedValuePath="Key"
                          Height="26"
                          FontSize="12"
                          BorderBrush="#FF90CAF9"
                          Padding="2"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Следующее звено при неудаче -->
            <DataGridTemplateColumn Header="Следующее (неудача)" Width="220">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="ID следующего звена при неудачном выполнении"/>
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.LinkOptions, 
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                          SelectedValue="{Binding FailureNextLink, UpdateSourceTrigger=PropertyChanged}"
                          DisplayMemberPath="Value"
                          SelectedValuePath="Key"
                          Height="26"
                          FontSize="12"
                          BorderBrush="#FF90CAF9"
                          Padding="2"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Максимальное количество повторений -->
            <DataGridTemplateColumn Header="Макс. повторений" Width="120">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="Максимальное количество повторений для циклических ссылок"/>
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <TextBox Text="{Binding MaxCyclicRepetitions, UpdateSourceTrigger=PropertyChanged}"
                         Height="24"
                         FontSize="12"
                         BorderBrush="#FF90CAF9"
                         Padding="2"
                         HorizontalContentAlignment="Center"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Описание -->
            <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="*">
              <DataGridTextColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="FontSize" Value="12"/>
                  <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
              </DataGridTextColumn.HeaderStyle>
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="TextWrapping" Value="Wrap"/>
                  <Setter Property="FontSize" Value="12"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
          </DataGrid.Columns>

        </DataGrid>
      </Grid>
    </Border>

    <!-- Панель управления звеньями -->
    <Border Grid.Row="4" 
            BorderBrush="#FFFFF3E0" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,5"
            Padding="10"
            Background="#FFFFF8E1">
      <StackPanel Orientation="Horizontal">
        <Button Content="➕ Добавить звено" 
                Click="AddLinkButton_Click"
                ToolTip="Добавить новое звено к цепочке"
                Width="140"
                Height="32"
                Margin="0,0,10,0"
                Background="#FF2196F3"
                BorderBrush="#FF1976D2"
                Foreground="White"
                FontWeight="SemiBold"/>

        <Button Content="🗑️ Удалить звено" 
                Click="RemoveLinkButton_Click"
                ToolTip="Удалить выбранное звено"
                Width="140"
                Height="32"
                Margin="0,0,10,0"
                Background="#FFF44336"
                BorderBrush="#FFD32F2F"
                Foreground="White"
                FontWeight="SemiBold"
                IsEnabled="{Binding IsLinkSelected}"/>

        <Button Content="✏️ Обновить звено" 
                Click="UpdateLinkButton_Click"
                ToolTip="Сохранить изменения в выбранном звене"
                Width="140"
                Height="32"
                Margin="0,0,10,0"
                Background="#FFFF9800"
                BorderBrush="#FFF57C00"
                Foreground="White"
                FontWeight="SemiBold"
                IsEnabled="{Binding IsLinkSelected}"/>

        <Button Content="✅ Проверить цепочку" 
                Click="ValidateChainButton_Click"
                ToolTip="Проверить целостность цепочки"
                Width="160"
                Height="32"
                Margin="0,0,20,0"
                Background="#FF4CAF50"
                BorderBrush="#FF388E3C"
                Foreground="White"
                FontWeight="SemiBold"/>
      </StackPanel>
    </Border>

    <!-- Кнопки сохранения/отмены -->
    <Border Grid.Row="5" 
            BorderBrush="#FFE0E0E0" 
            BorderThickness="1"
            CornerRadius="4"
            Padding="12"
            Background="#FFF5F5F5">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
          <TextBlock Text="Количество звеньев:"
                     FontSize="14"
                     FontStyle="Italic"
                     VerticalAlignment="Center"/>

          <TextBlock Text="{Binding ChainLinks.Count}"
                     FontSize="15"
                     FontWeight="Bold"
                     VerticalAlignment="Center"
                     Margin="5,0,20,0"/>
        </StackPanel>

        <Button Grid.Column="2"
                Content="Отмена" 
                Click="CancelButton_Click"
                Width="100"
                Height="32"
                Margin="0,0,10,0"
                Background="#FFF5F5F5"
                BorderBrush="#FF9E9E9E"
                Foreground="#FF333333"
                FontSize="13"/>

        <Button Grid.Column="3"
                Content="💾 Сохранить" 
                Click="SaveButton_Click"
                Width="120"
                Height="32"
                Background="#FF4CAF50"
                BorderBrush="#FF388E3C"
                Foreground="White"
                FontWeight="Bold"
                FontSize="13"
                IsEnabled="{Binding CanSave}"/>
      </Grid>
    </Border>
  </Grid>
</Window>
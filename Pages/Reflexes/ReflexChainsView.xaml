<UserControl x:Class="AIStudio.Pages.Reflexes.ReflexChainsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AIStudio.Pages.Reflexes"
             xmlns:converters="clr-namespace:AIStudio.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100">

  <UserControl.Resources>
    <converters:ListToStringConverter x:Key="ListToStringConverter"/>
    <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

    <!-- Конвертер для определения цвета текста валидации -->
    <converters:StringStartsWithConverter x:Key="StringStartsWithConverter"/>

    <Style x:Key="ChainDataGridStyle" TargetType="DataGrid">
      <Setter Property="Background" Value="White"/>
      <Setter Property="RowBackground" Value="#FFF9F9F9"/>
      <Setter Property="AlternatingRowBackground" Value="#FFF0F0F0"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="GridLinesVisibility" Value="None"/>
      <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
      <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
      <Setter Property="SelectionUnit" Value="FullRow"/>
      <Setter Property="CanUserAddRows" Value="False"/>
      <Setter Property="CanUserDeleteRows" Value="False"/>
    </Style>

    <Style x:Key="LinkDataGridStyle" TargetType="DataGrid" BasedOn="{StaticResource ChainDataGridStyle}">
      <Setter Property="Height" Value="180"/>
      <Setter Property="CanUserSortColumns" Value="False"/>
    </Style>

    <!-- Стиль для текста валидации -->
    <Style x:Key="ValidationTextStyle" TargetType="TextBlock">
      <Setter Property="VerticalAlignment" Value="Center"/>
      <Setter Property="FontSize" Value="12"/>
      <Style.Triggers>
        <DataTrigger Binding="{Binding ChainValidationResult}" Value="✓ Цепочка валидна">
          <Setter Property="Foreground" Value="Green"/>
          <Setter Property="FontWeight" Value="Bold"/>
        </DataTrigger>
        <DataTrigger Binding="{Binding ChainValidationResult, Converter={StaticResource StringStartsWithConverter}, ConverterParameter='✗'}">
          <Setter Property="Foreground" Value="Red"/>
          <Setter Property="FontWeight" Value="Bold"/>
        </DataTrigger>
        <DataTrigger Binding="{Binding ChainValidationResult}" Value="Не выбрана цепочка">
          <Setter Property="Foreground" Value="Gray"/>
          <Setter Property="FontStyle" Value="Italic"/>
        </DataTrigger>
      </Style.Triggers>
    </Style>

    <!-- Стиль для выделенной строки -->
    <Style x:Key="HighlightedRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <Trigger Property="IsSelected" Value="True">
          <Setter Property="Background" Value="#FFE3F2FD"/>
          <Setter Property="BorderBrush" Value="#FF2196F3"/>
          <Setter Property="BorderThickness" Value="1"/>
        </Trigger>
      </Style.Triggers>
    </Style>

  </UserControl.Resources>

  <Grid Margin="10">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="220"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Заголовок -->
    <Border Grid.Row="0" 
                Background="#FF2196F3" 
                CornerRadius="4"
                Margin="0,0,0,10"
                Padding="10">
      <StackPanel>
        <TextBlock Text="Управление цепочками рефлексов" 
                           FontSize="18"
                           FontWeight="SemiBold"
                           HorizontalAlignment="Center"
                           Foreground="White"/>
        <TextBlock Text="Создание и редактирование последовательностей рефлексов"
                           FontSize="12"
                           HorizontalAlignment="Center"
                           Foreground="White"
                           Opacity="0.9"
                           Margin="0,5,0,0"/>
      </StackPanel>
    </Border>

    <!-- Панель фильтров -->
    <Border Grid.Row="1" 
                BorderBrush="#FFBBDEFB" 
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,0,0,10"
                Padding="8"
                Background="#FFE3F2FD">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="Фильтры:" 
                           VerticalAlignment="Center" 
                           Margin="0,0,10,0"
                           FontWeight="Bold"
                           Foreground="#FF0D47A1"/>

        <!-- Фильтр по имени -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0" Width="250">
          <TextBlock Text="Название цепочки" FontSize="12" Margin="0,0,0,2" Foreground="#FF0D47A1"/>
          <TextBox Text="{Binding NameFilter, UpdateSourceTrigger=PropertyChanged}"
                             Height="28"
                             Padding="4"
                             BorderBrush="#FF90CAF9"
                             BorderThickness="1"
                             Background="White"/>
        </StackPanel>

        <!-- Фильтр по приоритету -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0" Width="180">
          <TextBlock Text="Приоритет" FontSize="12" Margin="0,0,0,2" Foreground="#FF0D47A1"/>
          <ComboBox ItemsSource="{Binding PriorityFilterOptions}"
                              SelectedValue="{Binding SelectedPriorityFilter}"
                              DisplayMemberPath="Value"
                              SelectedValuePath="Key"
                              Height="28"
                              BorderBrush="#FF90CAF9"
                              Background="White"/>
        </StackPanel>

        <!-- Кнопка сброса фильтров -->
        <Button Content="Сбросить фильтры" 
                        Command="{Binding ClearFiltersCommand}"
                        Style="{StaticResource AgentButtonStyle}"
                        Margin="10,15,0,0"
                        Height="30"
                        Width="130"
                        HorizontalAlignment="Right"
                        Background="#FFE8EAF6"
                        BorderBrush="#FF5C6BC0"/>
      </StackPanel>
    </Border>

    <!-- Таблица цепочек -->
    <Border Grid.Row="2" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,0,0,5">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Заголовок таблицы -->
        <Border Grid.Row="0" 
                        Background="#FFF5F5F5" 
                        BorderBrush="#FFE0E0E0" 
                        BorderThickness="0,0,0,1"
                        Padding="8">
          <TextBlock Text="Список цепочек" 
                               FontWeight="Bold"
                               FontSize="14"
                               Foreground="#FF333333"/>
        </Border>

        <!-- Таблица -->
        <DataGrid Grid.Row="1"
                          x:Name="ChainsDataGrid"
                          ItemsSource="{Binding ReflexChainsView}"
                          SelectedItem="{Binding SelectedChain, Mode=TwoWay}"
                          Style="{StaticResource ChainDataGridStyle}"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          RowStyle="{StaticResource HighlightedRowStyle}">
          <DataGrid.Columns>
            <DataGridTextColumn Header="ID" Binding="{Binding ID}" Width="50" IsReadOnly="True"/>
            <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="200">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
            <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="300"/>
            <DataGridTextColumn Header="Приоритет" Binding="{Binding Priority}" Width="80">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
            <DataGridTextColumn Header="Звеньев" Binding="{Binding Links.Count}" Width="80">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
            <DataGridCheckBoxColumn Header="Активна" Binding="{Binding IsActive}" Width="80">
              <DataGridCheckBoxColumn.ElementStyle>
                <Style TargetType="CheckBox">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="VerticalAlignment" Value="Center"/>
                  <Setter Property="IsEnabled" Value="False"/>
                </Style>
              </DataGridCheckBoxColumn.ElementStyle>
            </DataGridCheckBoxColumn>
          </DataGrid.Columns>
        </DataGrid>
      </Grid>
    </Border>

    <!-- Панель управления цепочками -->
    <Border Grid.Row="3" 
                BorderBrush="#FFC8E6C9" 
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,0,0,5"
                Padding="10"
                Background="#FFF1F8E9">
      <StackPanel Orientation="Horizontal">
        <Button Content="➕ Новая цепочка" 
                        Command="{Binding AddChainCommand}"
                        ToolTip="Создать новую цепочку рефлексов"
                        Width="140"
                        Height="32"
                        Margin="0,0,10,0"
                        Background="#FF4CAF50"
                        BorderBrush="#FF388E3C"
                        Foreground="White"
                        FontWeight="SemiBold"/>

        <Button Content="🗑️ Удалить цепочку" 
                        Command="{Binding RemoveChainCommand}"
                        ToolTip="Удалить выбранную цепочку"
                        Width="150"
                        Height="32"
                        Margin="0,0,10,0"
                        Background="#FFF44336"
                        BorderBrush="#FFD32F2F"
                        Foreground="White"
                        FontWeight="SemiBold"
                        IsEnabled="{Binding IsChainSelected}"/>

        <Button Content="✅ Проверить цепочку" 
                        Command="{Binding ValidateChainCommand}"
                        ToolTip="Проверить целостность выбранной цепочки"
                        Width="160"
                        Height="32"
                        Margin="0,0,20,0"
                        Background="#FF2196F3"
                        BorderBrush="#FF1976D2"
                        Foreground="White"
                        FontWeight="SemiBold"
                        IsEnabled="{Binding IsChainSelected}"/>

        <!-- Результат валидации -->
        <Border Background="White" 
                        BorderBrush="#FFBDBDBD" 
                        BorderThickness="1"
                        CornerRadius="3"
                        Padding="8,4"
                        VerticalAlignment="Center">
          <TextBlock Text="{Binding ChainValidationResult}"
                               Style="{StaticResource ValidationTextStyle}"
                               MinWidth="200"
                               TextWrapping="Wrap"/>
        </Border>
      </StackPanel>
    </Border>

    <!-- Таблица звеньев выбранной цепочки -->
    <Border Grid.Row="4" 
                BorderBrush="#FFE0E0E0" 
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,0,0,5">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Заголовок таблицы звеньев -->
        <Border Grid.Row="0" 
                        Background="#FFE8EAF6" 
                        BorderBrush="#FFE0E0E0" 
                        BorderThickness="0,0,0,1"
                        Padding="8">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto"/>
              <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                                   Text="Звенья цепочки" 
                                   FontWeight="Bold"
                                   FontSize="14"
                                   Foreground="#FF3F51B5"
                                   VerticalAlignment="Center"/>

            <TextBlock Grid.Column="1"
                                   Text="{Binding SelectedChain.Name, StringFormat=' - {0}'}"
                                   FontSize="14"
                                   Foreground="#FF5C6BC0"
                                   VerticalAlignment="Center"
                                   Margin="5,0,0,0"
                                   FontStyle="Italic"/>
          </Grid>
        </Border>

        <!-- Таблица звеньев -->
        <DataGrid Grid.Row="1"
                          x:Name="LinksDataGrid"
                          ItemsSource="{Binding CurrentChainLinks}"
                          SelectedItem="{Binding SelectedLink, Mode=TwoWay}"
                          Style="{StaticResource LinkDataGridStyle}"
                          AutoGenerateColumns="False"
                          SelectionMode="Single"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          RowStyle="{StaticResource HighlightedRowStyle}"
                          IsEnabled="{Binding IsChainSelected}">
          <DataGrid.Columns>
            <DataGridTextColumn Header="ID" Binding="{Binding ID}" Width="50" IsReadOnly="True">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="Padding" Value="4,2"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>

            <!-- Рефлекс -->
            <DataGridTemplateColumn Header="Рефлекс" Width="180">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="ID рефлекса для выполнения в этом звене"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.ReflexOptions, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              SelectedValue="{Binding ReflexID, UpdateSourceTrigger=PropertyChanged}"
                                              DisplayMemberPath="Value"
                                              SelectedValuePath="Key"
                                              Height="24"
                                              BorderBrush="#FF90CAF9"
                                              Padding="2"/>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Следующее звено при успехе -->
            <DataGridTemplateColumn Header="Следующее (успех)" Width="150">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="ID следующего звена при успешном выполнении"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.LinkOptions, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              SelectedValue="{Binding SuccessNextLink, UpdateSourceTrigger=PropertyChanged}"
                                              DisplayMemberPath="Value"
                                              SelectedValuePath="Key"
                                              Height="24"
                                              BorderBrush="#FF90CAF9"
                                              Padding="2"
                                              IsEnabled="{Binding IsTerminal, Converter={StaticResource InverseBooleanConverter}}">
                    <ComboBox.Style>
                      <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding IsTerminal}" Value="True">
                            <Setter Property="Background" Value="#FFF5F5F5"/>
                            <Setter Property="Foreground" Value="#FF9E9E9E"/>
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </ComboBox.Style>
                  </ComboBox>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Следующее звено при неудаче -->
            <DataGridTemplateColumn Header="Следующее (неудача)" Width="150">
              <DataGridTemplateColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="ID следующего звена при неудачном выполнении"/>
                </Style>
              </DataGridTemplateColumn.HeaderStyle>
              <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                  <ComboBox ItemsSource="{Binding DataContext.LinkOptions, 
                                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                                              SelectedValue="{Binding FailureNextLink, UpdateSourceTrigger=PropertyChanged}"
                                              DisplayMemberPath="Value"
                                              SelectedValuePath="Key"
                                              Height="24"
                                              BorderBrush="#FF90CAF9"
                                              Padding="2"
                                              IsEnabled="{Binding IsTerminal, Converter={StaticResource InverseBooleanConverter}}">
                    <ComboBox.Style>
                      <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding IsTerminal}" Value="True">
                            <Setter Property="Background" Value="#FFF5F5F5"/>
                            <Setter Property="Foreground" Value="#FF9E9E9E"/>
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </ComboBox.Style>
                  </ComboBox>
                </DataTemplate>
              </DataGridTemplateColumn.CellTemplate>
            </DataGridTemplateColumn>

            <!-- Терминальное звено -->
            <DataGridCheckBoxColumn Header="Терминальное" Binding="{Binding IsTerminal}" Width="100">
              <DataGridCheckBoxColumn.HeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                  <Setter Property="ToolTip" Value="Если отмечено, цепочка завершается после этого звена"/>
                </Style>
              </DataGridCheckBoxColumn.HeaderStyle>
              <DataGridCheckBoxColumn.ElementStyle>
                <Style TargetType="CheckBox">
                  <Setter Property="HorizontalAlignment" Value="Center"/>
                  <Setter Property="VerticalAlignment" Value="Center"/>
                </Style>
              </DataGridCheckBoxColumn.ElementStyle>
            </DataGridCheckBoxColumn>

            <!-- Описание -->
            <DataGridTextColumn Header="Описание" Binding="{Binding Description}" Width="*">
              <DataGridTextColumn.ElementStyle>
                <Style TargetType="TextBlock">
                  <Setter Property="Padding" Value="4,2"/>
                  <Setter Property="TextWrapping" Value="Wrap"/>
                </Style>
              </DataGridTextColumn.ElementStyle>
            </DataGridTextColumn>
          </DataGrid.Columns>
        </DataGrid>
      </Grid>
    </Border>

    <!-- Панель управления звеньями и сохранения -->
    <Border Grid.Row="5" 
                BorderBrush="#FFFFF3E0" 
                BorderThickness="1"
                CornerRadius="4"
                Padding="10"
                Background="#FFFFF8E1">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Панель управления звеньями -->
        <StackPanel Grid.Column="0" Orientation="Horizontal">
          <Button Content="➕ Добавить звено" 
                            Command="{Binding AddLinkCommand}"
                            ToolTip="Добавить новое звено к выбранной цепочке"
                            Width="140"
                            Height="32"
                            Margin="0,0,10,0"
                            Background="#FF2196F3"
                            BorderBrush="#FF1976D2"
                            Foreground="White"
                            FontWeight="SemiBold"
                            IsEnabled="{Binding IsChainSelected}"/>

          <Button Content="🗑️ Удалить звено" 
                            Command="{Binding RemoveLinkCommand}"
                            ToolTip="Удалить выбранное звено"
                            Width="140"
                            Height="32"
                            Margin="0,0,10,0"
                            Background="#FFF44336"
                            BorderBrush="#FFD32F2F"
                            Foreground="White"
                            FontWeight="SemiBold"
                            IsEnabled="{Binding IsLinkSelected}"/>

          <Button Content="✏️ Обновить звено" 
                            Command="{Binding UpdateLinkCommand}"
                            ToolTip="Сохранить изменения в выбранном звене"
                            Width="140"
                            Height="32"
                            Margin="0,0,10,0"
                            Background="#FFFF9800"
                            BorderBrush="#FFF57C00"
                            Foreground="White"
                            FontWeight="SemiBold"
                            IsEnabled="{Binding IsLinkSelected}"/>
        </StackPanel>

        <!-- Кнопка сохранения -->
        <Button Grid.Column="1"
                        Content="💾 Сохранить всё" 
                        Command="{Binding SaveCommand}"
                        ToolTip="Сохранить все изменения цепочек и звеньев"
                        Width="140"
                        Height="32"
                        Background="#FF4CAF50"
                        BorderBrush="#FF388E3C"
                        Foreground="White"
                        FontWeight="Bold"
                        FontSize="13"/>
      </Grid>
    </Border>

    <!-- Сообщение о необходимости рефлексов -->
    <Border Grid.Row="0" Grid.RowSpan="6"
                Background="#FFF44336"
                CornerRadius="4"
                Padding="15"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Visibility="{Binding CanCreateChains, Converter={StaticResource InverseBooleanConverter}, ConverterParameter=Visible}">
      <StackPanel>
        <TextBlock Text="⚠️ Внимание!" 
                           FontSize="16"
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,10"/>
        <TextBlock Text="Для работы с цепочками рефлексов необходимо сначала создать безусловные рефлексы."
                           Foreground="White"
                           TextWrapping="Wrap"
                           MaxWidth="400"
                           TextAlignment="Center"
                           FontSize="14"/>
        <TextBlock Text="Перейдите на страницу 'Безусловные рефлексы' для создания рефлексов."
                           Foreground="White"
                           TextWrapping="Wrap"
                           MaxWidth="400"
                           TextAlignment="Center"
                           FontSize="14"
                           Margin="0,10,0,0"
                           FontStyle="Italic"/>
      </StackPanel>
    </Border>

  </Grid>
</UserControl>
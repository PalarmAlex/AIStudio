<Window x:Class="AIStudio.Dialogs.AutomatizmLoadDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Создание автоматизмов по шаблону" 
        Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        ShowInTaskbar="False"
        PreviewKeyDown="Window_PreviewKeyDown"
        Loaded="Window_Loaded">

  <Window.Resources>
    <Style x:Key="DialogHeaderStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="16"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Margin" Value="0,0,0,10"/>
    </Style>

    <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
      <Setter Property="FontSize" Value="13"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="Margin" Value="0,6,0,4"/>
    </Style>

    <Style x:Key="InfoTextStyle" TargetType="TextBlock">
      <Setter Property="Foreground" Value="#FF666666"/>
      <Setter Property="FontStyle" Value="Italic"/>
      <Setter Property="Margin" Value="0,0,0,6"/>
    </Style>

    <Style x:Key="TabHeaderStyle" TargetType="TabItem">
      <Setter Property="FontSize" Value="12"/>
      <Setter Property="Padding" Value="10,3"/>
    </Style>

    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
  </Window.Resources>

  <Grid Margin="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Оверлей индикации загрузки -->
    <Grid x:Name="BusyOverlay" 
          Grid.RowSpan="3"
          Background="#80FFFFFF" 
          Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"
          Panel.ZIndex="1000">
      <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
        <ProgressBar IsIndeterminate="True" 
                     Width="200" Height="20" 
                     Margin="0,0,0,10"/>
        <TextBlock Text="Создание автоматизмов..." 
                   HorizontalAlignment="Center"
                   FontSize="14"/>
      </StackPanel>
    </Grid>

    <!-- Заголовок -->
    <TextBlock Grid.Row="0" 
               Text="Создание автоматизмов по шаблону"
               Style="{StaticResource DialogHeaderStyle}"/>

    <!-- Таб контроль для переключения между режимами -->
    <TabControl Grid.Row="1" Margin="0,6,0,6" x:Name="MainTabControl">
      <!-- Вкладка параметров -->
      <TabItem Header="Параметры" Style="{StaticResource TabHeaderStyle}">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="0,10,0,0">
            <!-- Выбор базового состояния -->
            <StackPanel Margin="0,0,0,10">
              <TextBlock Text="Базовое состояние агента"
                         Style="{StaticResource SectionHeaderStyle}"/>

              <ComboBox ItemsSource="{Binding BaseStates}"
                        DisplayMemberPath="Value"
                        SelectedValuePath="Key"
                        SelectedValue="{Binding SelectedBaseState}"
                        Height="30"
                        Width="250"
                        HorizontalAlignment="Left"
                        Margin="0,5,0,0"/>
            </StackPanel>

            <!-- Выбор комбинации стилей -->
            <StackPanel Margin="0,0,0,10">
              <TextBlock Text="Комбинация стилей поведения"
                         Style="{StaticResource SectionHeaderStyle}"/>

              <DockPanel Margin="0,5,0,0">
                <ComboBox ItemsSource="{Binding StyleCombinations}"
                          DisplayMemberPath="DisplayName"
                          SelectedValuePath="StyleIds"
                          SelectedValue="{Binding SelectedStyleIds}"
                          Height="30"
                          DockPanel.Dock="Left"
                          Width="500"/>

                <Button Content="Обновить список"
                        Command="{Binding LoadStylesCommand}"
                        Height="30"
                        Width="120"
                        Margin="10,0,0,0"
                        DockPanel.Dock="Right"/>
              </DockPanel>

              <TextBlock Text="{Binding StylesStatusText}"
                         Style="{StaticResource InfoTextStyle}"
                         Margin="0,5,0,0"
                         TextWrapping="Wrap"/>

              <!-- Индикатор выбора стилей -->
              <TextBlock Text="{Binding SelectedStyleValidationMessage}"
                         Foreground="{Binding SelectedStyleValidationColor}"
                         Margin="0,5,0,0"
                         FontSize="11"
                         Visibility="{Binding ShowStyleValidation, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>

            <!-- Предупреждение о необходимости выбора -->
            <Border BorderBrush="#FFF0E68C"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="8"
                    Background="#FFFFFACD"
                    Margin="0,0,0,10"
                    Visibility="{Binding ShowSelectionWarning, Converter={StaticResource BooleanToVisibilityConverter}}">
              <TextBlock Text="Для создания автоматизмов выберите базовое состояние и комбинацию стилей, затем введите текст цепочек во вкладке «Текст цепочек»."
                         Foreground="#8B4513"
                         FontWeight="SemiBold"
                         TextWrapping="Wrap"/>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </TabItem>

      <!-- Вкладка ввода текста цепочек -->
      <TabItem Header="Текст цепочек" Style="{StaticResource TabHeaderStyle}">
        <Grid Margin="0,10,0,0">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <!-- Формат текста -->
          <Border Grid.Row="0"
                  BorderBrush="#FFE0E0E0" 
                  BorderThickness="1"
                  CornerRadius="4"
                  Padding="8"
                  Background="#FFF9F9F9"
                  Margin="0,0,0,8">
            <StackPanel>
              <TextBlock Text="Формат шаблона" 
                         FontWeight="SemiBold"
                         Margin="0,0,0,5"/>
              <TextBlock TextWrapping="Wrap"
                         Style="{StaticResource InfoTextStyle}">
                <Run Text="• Каждая строка — одна цепочка диалога (последовательность фраз)"/><LineBreak/>
                <Run Text="• Фразы в строке разделяются символом «;» или « - »"/><LineBreak/>
                <Run Text="• Например: "/><Run Text="приветик;как спалось;отличненько" FontFamily="Consolas"/>
              </TextBlock>
            </StackPanel>
          </Border>

          <!-- Текстовое поле ввода цепочек -->
          <TextBox Grid.Row="1"
                   x:Name="CsvEditorTextBox"
                   Text="{Binding CsvContent, UpdateSourceTrigger=PropertyChanged}"
                   AcceptsReturn="True"
                   AcceptsTab="True"
                   FontFamily="Consolas"
                   FontSize="12"
                   VerticalScrollBarVisibility="Auto"
                   HorizontalScrollBarVisibility="Auto"
                   Padding="4"
                   BorderBrush="#FFE0E0E0"
                   BorderThickness="1"
                   IsEnabled="{Binding IsEditingEnabled}"/>

          <!-- Кнопки для редактирования -->
          <StackPanel Grid.Row="2"
                      Orientation="Horizontal"
                      HorizontalAlignment="Right"
                      Margin="0,10,0,0">
            <Button Content="Сохранить в файл"
                    Command="{Binding SaveCsvCommand}"
                    Height="35"
                    Width="130"
                    Margin="0,0,10,0"
                    Cursor="Hand"
                    ToolTip="Сохранить текст в CSV-файл"/>

            <Button Content="Проверить формат"
                    Command="{Binding ValidateCsvCommand}"
                    Height="35"
                    Width="130"
                    Cursor="Hand"/>
          </StackPanel>
        </Grid>
      </TabItem>

      <!-- Вкладка редактирования промпта для ИИ - 1 шаг -->
      <TabItem Header="Промпт для ИИ - 1 шаг" Style="{StaticResource TabHeaderStyle}">
        <Grid Margin="0,10,0,0">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <!-- Информация о промпте -->
          <Border Grid.Row="0"
                  BorderBrush="#FFE0E0E0" 
                  BorderThickness="1"
                  CornerRadius="4"
                  Padding="8"
                  Background="#FFF9F9F9"
                  Margin="0,0,0,8">
            <StackPanel>
              <TextBlock Text="Редактирование промпта для ИИ - 1 шаг" 
                         FontWeight="SemiBold"
                         Margin="0,0,0,5"/>
              <TextBlock Text="{Binding PromptFilePath1, Mode=OneWay}"
                         TextWrapping="Wrap"
                         Style="{StaticResource InfoTextStyle}"/>
              <TextBlock Text="Этот промпт используется при генерации групп параметров для промпта 2. Вы можете отредактировать его по своему усмотрению."
                         Style="{StaticResource InfoTextStyle}"
                         Margin="0,5,0,0"
                         TextWrapping="Wrap"/>
            </StackPanel>
          </Border>

          <!-- Текстовое поле для редактирования промпта -->
          <TextBox Grid.Row="1"
                   x:Name="Prompt1EditorTextBox"
                   Text="{Binding PromptContent1, UpdateSourceTrigger=PropertyChanged}"
                   AcceptsReturn="True"
                   AcceptsTab="True"
                   FontFamily="Segoe UI"
                   FontSize="12"
                   VerticalScrollBarVisibility="Auto"
                   HorizontalScrollBarVisibility="Auto"
                   Padding="4"
                   BorderBrush="#FFE0E0E0"
                   BorderThickness="1"
                   IsEnabled="{Binding IsPrompt1EditingEnabled}"/>

          <!-- Кнопки для редактирования промпта -->
          <StackPanel Grid.Row="2"
                      Orientation="Horizontal"
                      HorizontalAlignment="Right"
                      Margin="0,10,0,0">
            <Button Content="Сохранить промпт"
                    Command="{Binding SavePrompt1Command}"
                    Height="35"
                    Width="150"
                    Margin="0,0,10,0"
                    Cursor="Hand"
                    ToolTip="Сохранить изменения в файл промпта"/>
          </StackPanel>
        </Grid>
      </TabItem>

      <!-- Вкладка редактирования промпта для ИИ - 2 шаг -->
      <TabItem Header="Промпт для ИИ - 2 шаг" Style="{StaticResource TabHeaderStyle}">
        <Grid Margin="0,10,0,0">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>

          <!-- Информация о промпте -->
          <Border Grid.Row="0"
                  BorderBrush="#FFE0E0E0" 
                  BorderThickness="1"
                  CornerRadius="4"
                  Padding="8"
                  Background="#FFF9F9F9"
                  Margin="0,0,0,8">
            <StackPanel>
              <TextBlock Text="Редактирование промпта для ИИ - 2 шаг" 
                         FontWeight="SemiBold"
                         Margin="0,0,0,5"/>
              <TextBlock Text="{Binding PromptFilePath, Mode=OneWay}"
                         TextWrapping="Wrap"
                         Style="{StaticResource InfoTextStyle}"/>
              <TextBlock Text="Этот промпт используется при генерации текста цепочек диалога через ИИ (шаг 2). Вы можете отредактировать его по своему усмотрению."
                         Style="{StaticResource InfoTextStyle}"
                         Margin="0,5,0,0"
                         TextWrapping="Wrap"/>
            </StackPanel>
          </Border>

          <!-- Текстовое поле для редактирования промпта -->
          <TextBox Grid.Row="1"
                   x:Name="PromptEditorTextBox"
                   Text="{Binding PromptContent, UpdateSourceTrigger=PropertyChanged}"
                   AcceptsReturn="True"
                   AcceptsTab="True"
                   FontFamily="Segoe UI"
                   FontSize="12"
                   VerticalScrollBarVisibility="Auto"
                   HorizontalScrollBarVisibility="Auto"
                   Padding="4"
                   BorderBrush="#FFE0E0E0"
                   BorderThickness="1"
                   IsEnabled="{Binding IsPromptEditingEnabled}"/>

          <!-- Кнопки для редактирования промпта -->
          <StackPanel Grid.Row="2"
                      Orientation="Horizontal"
                      HorizontalAlignment="Right"
                      Margin="0,10,0,0">
            <Button Content="Сохранить промпт"
                    Command="{Binding SavePromptCommand}"
                    Height="35"
                    Width="150"
                    Margin="0,0,10,0"
                    Cursor="Hand"
                    ToolTip="Сохранить изменения в файл промпта"/>
          </StackPanel>
        </Grid>
      </TabItem>
    </TabControl>

    <!-- Кнопки диалога -->
    <StackPanel Grid.Row="2" 
                Orientation="Horizontal" 
                HorizontalAlignment="Right"
                Margin="0,10,0,0">
      <Button Content="Создать" 
              Command="{Binding ApplyCommand}"
              IsEnabled="{Binding CanApply}"
              Height="35" 
              Width="120"
              Margin="0,0,10,0"
              Cursor="Hand"
              ToolTip="Создать автоматизмы по введённому тексту цепочек с выбранными параметрами"/>

      <Button Content="Отмена" 
              Command="{Binding CancelCommand}"
              Height="35" 
              Width="100"
              Cursor="Hand"/>
    </StackPanel>
  </Grid>
</Window>
<UserControl x:Class="AIStudio.Pages.Automatizm.AutomatizmChainsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AIStudio.Pages"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1200">

  <UserControl.Resources>
    <Style x:Key="BaseTextBlockStyle" TargetType="TextBlock">
      <Setter Property="Background" Value="White"/>
      <Style.Triggers>
        <Trigger Property="Validation.HasError" Value="true">
          <Setter Property="Background" Value="#FFFDE6E6"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <Style x:Key="FilterTextBoxStyle" TargetType="TextBox">
      <Setter Property="Margin" Value="0,0,15,0"/>
      <Setter Property="Width" Value="120"/>
      <Setter Property="Height" Value="25"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="Background" Value="White"/>
      <Setter Property="BorderBrush" Value="#FFCCCCCC"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="Padding" Value="4,2"/>
    </Style>

    <Style x:Key="FilterComboBoxStyle" TargetType="ComboBox">
      <Setter Property="Margin" Value="0,0,15,0"/>
      <Setter Property="Width" Value="180"/>
      <Setter Property="Height" Value="25"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="Background" Value="White"/>
      <Setter Property="BorderBrush" Value="#FFCCCCCC"/>
    </Style>

    <Style x:Key="CloseButtonStyle" TargetType="Button">
      <Setter Property="Width" Value="100"/>
      <Setter Property="Height" Value="30"/>
      <Setter Property="Background" Value="#FF007ACC"/>
      <Setter Property="Foreground" Value="White"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="Cursor" Value="Hand"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
          <Setter Property="Background" Value="#FF1C97EA"/>
        </Trigger>
        <Trigger Property="IsPressed" Value="True">
          <Setter Property="Background" Value="#FF005A9E"/>
        </Trigger>
      </Style.Triggers>
    </Style>

  </UserControl.Resources>

  <Grid Margin="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Заголовок -->
    <TextBlock Grid.Row="0" 
               Text="Цепочки автоматизмов" 
               FontSize="18"
               FontWeight="SemiBold"
               HorizontalAlignment="Center"
               Margin="0,0,0,15"
               Foreground="#FF333333"/>

    <!-- Панель фильтров -->
    <Border Grid.Row="1" 
            BorderBrush="#FFE0E0E0" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,10"
            Padding="10"
            Background="#FFF5F5F5">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="Фильтры:" 
                   VerticalAlignment="Center" 
                   Margin="0,0,15,0"
                   FontWeight="Bold"/>

        <!-- Фильтр по ID автоматизма -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0">
          <TextBlock Text="ID автоматизма" FontSize="12" Margin="0,0,0,2"/>
          <TextBox Style="{StaticResource FilterTextBoxStyle}"
                   Text="{Binding FilterAutomatizmId, UpdateSourceTrigger=PropertyChanged}"
                   ToolTip="Фильтр по ID автоматизма"/>
        </StackPanel>

        <!-- Фильтр по ID цепочки -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0">
          <TextBlock Text="ID цепочки" FontSize="12" Margin="0,0,0,2"/>
          <TextBox Style="{StaticResource FilterTextBoxStyle}"
                   Text="{Binding FilterChainId, UpdateSourceTrigger=PropertyChanged}"
                   ToolTip="Фильтр по ID цепочки"/>
        </StackPanel>

        <!-- Фильтр по действиям -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0">
          <TextBlock Text="Действия" FontSize="12" Margin="0,0,0,2"/>
          <TextBox Style="{StaticResource FilterTextBoxStyle}"
                   Text="{Binding FilterActions, UpdateSourceTrigger=PropertyChanged}"
                   ToolTip="Фильтр по названиям действий"/>
        </StackPanel>

        <!-- Фильтр по фразам -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0">
          <TextBlock Text="Фразы" FontSize="12" Margin="0,0,0,2"/>
          <TextBox Style="{StaticResource FilterTextBoxStyle}"
                   Text="{Binding FilterPhrases, UpdateSourceTrigger=PropertyChanged}"
                   ToolTip="Фильтр по тексту фраз"/>
        </StackPanel>

        <!-- Фильтр по типу образа -->
        <StackPanel Orientation="Vertical" Margin="0,0,15,0">
          <TextBlock Text="Тип образа" FontSize="12" Margin="0,0,0,2"/>
          <ComboBox Style="{StaticResource AgentComboBoxStyle}"
                    ItemsSource="{Binding ImageKindOptions}"
                    SelectedValue="{Binding FilterImageKind}"
                    DisplayMemberPath="Value"
                    SelectedValuePath="Key"
                    Height="25"/>
        </StackPanel>

        <!-- Кнопка сброса фильтров -->
        <Button Content="Сбросить фильтры" 
                Command="{Binding ClearFiltersCommand}"
                Style="{StaticResource AgentButtonStyle}"
                Margin="10,15,0,0"
                Height="30"
                Width="150"
                Cursor="Hand"
                HorizontalAlignment="Right"/>
      </StackPanel>
    </Border>

    <!-- Таблица цепочек -->
    <Border Grid.Row="2" 
            BorderBrush="#FFE0E0E0" 
            BorderThickness="1"
            CornerRadius="4"
            Margin="0,0,0,10">
      <DataGrid ItemsSource="{Binding ChainsView}"
                x:Name="ChainsGrid"
                IsEnabled="True"
                IsReadOnly="True"
                AutoGenerateColumns="False"
                CanUserAddRows="False"
                SelectionMode="Extended"
                BorderThickness="0"
                Background="White"
                RowBackground="#FFF9F9F9"
                AlternatingRowBackground="White"
                GridLinesVisibility="None"
                VerticalScrollBarVisibility="Auto"
                HorizontalScrollBarVisibility="Auto"
                ColumnWidth="Auto">

        <DataGrid.Columns>
          <!-- ID автоматизма -->
          <DataGridTextColumn Header="ID автомат." 
                              Binding="{Binding AutomatizmId}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="ID автоматизма, к которому привязан цепочка"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

          <!-- ID цепочки -->
          <DataGridTextColumn Header="ID цепочки" 
                              Binding="{Binding ChainId}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="ID цепочки автоматизма"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

          <!-- ID звена цепочки -->
          <DataGridTextColumn Header="ID звена" 
                              Binding="{Binding LinkId}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="ID звена цепочки автоматизма"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

          <!-- Тип образа -->
          <DataGridTemplateColumn Header="Тип образа" Width="120">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding ImageKindText}"
                           HorizontalAlignment="Center"
                           ToolTip="{Binding ImageKindTooltip}"/>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
            <DataGridTemplateColumn.CellStyle>
              <Style TargetType="DataGridCell">
                <Setter Property="HorizontalContentAlignment" Value="Center"/>
              </Style>
            </DataGridTemplateColumn.CellStyle>
            
          </DataGridTemplateColumn>

          <!-- Действия -->
          <DataGridTemplateColumn Header="Действия" Width="200">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding ActionsText}"
                           TextWrapping="Wrap"
                           ToolTip="{Binding ActionsText}">
                  <TextBlock.Style>
                    <Style TargetType="TextBlock">
                      <Setter Property="FontStyle" Value="Normal"/>
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding ActionsText}" Value="">
                          <Setter Property="Text" Value="нет"/>
                          <Setter Property="FontStyle" Value="Italic"/>
                          <Setter Property="Foreground" Value="Gray"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
            <DataGridTemplateColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="Составляющая образа действия звена цепочки: действия"/>
              </Style>
            </DataGridTemplateColumn.HeaderStyle>
          </DataGridTemplateColumn>

          <!-- Фразы -->
          <DataGridTemplateColumn Header="Фразы" Width="200">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding PhrasesText}"
                           TextWrapping="Wrap"
                           ToolTip="{Binding PhrasesText}">
                  <TextBlock.Style>
                    <Style TargetType="TextBlock">
                      <Setter Property="FontStyle" Value="Normal"/>
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding PhrasesText}" Value="">
                          <Setter Property="Text" Value="нет"/>
                          <Setter Property="FontStyle" Value="Italic"/>
                          <Setter Property="Foreground" Value="Gray"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
            <DataGridTemplateColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="Составляющая образа действия звена цепочки: фразы"/>
              </Style>
            </DataGridTemplateColumn.HeaderStyle>
          </DataGridTemplateColumn>

          <!-- Тон/Настроение -->
          <DataGridTemplateColumn Header="Тон/Настроение" Width="120">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding ToneMoodText}"
                           HorizontalAlignment="Center"
                           ToolTip="{Binding ToneMoodText}">
                  <TextBlock.Style>
                    <Style TargetType="TextBlock">
                      <Setter Property="FontStyle" Value="Normal"/>
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding ToneMoodText}" Value="">
                          <Setter Property="Text" Value="нет"/>
                          <Setter Property="FontStyle" Value="Italic"/>
                          <Setter Property="Foreground" Value="Gray"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
            <DataGridTemplateColumn.CellStyle>
              <Style TargetType="DataGridCell">
                <Setter Property="HorizontalContentAlignment" Value="Center"/>
              </Style>
            </DataGridTemplateColumn.CellStyle>
            <DataGridTemplateColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="Составляющая образа действия звена цепочки: тон и настроение"/>
              </Style>
            </DataGridTemplateColumn.HeaderStyle>
          </DataGridTemplateColumn>

          <!-- ID следующего звена при успехе -->
          <DataGridTextColumn Header="Шаг успех" 
                              Binding="{Binding SuccessNextLink}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="ID звена следующего цепочки автоматизма при успешном завершении текущего"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

          <!-- ID следующего звена при неудаче -->
          <DataGridTextColumn Header="Шаг неудача" 
                              Binding="{Binding FailureNextLink}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="ID звена следующего цепочки автоматизма при неудачном завершении текущего"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

          <!-- Оценка звена -->
          <DataGridTextColumn Header="Оценка" 
                              Binding="{Binding SuccessThreshold}" 
                              Width="Auto"
                              IsReadOnly="True">
            <DataGridTextColumn.ElementStyle>
              <Style TargetType="TextBlock">
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="Foreground" Value="Black"/>
                <Setter Property="FontWeight" Value="Normal"/>
                <Style.Triggers>
                  <DataTrigger Binding="{Binding SuccessThreshold}" Value="0">
                    <Setter Property="FontWeight" Value="Bold"/>
                    <Setter Property="Foreground" Value="#FF0066CC"/>
                  </DataTrigger>
                  <DataTrigger Binding="{Binding SuccessThreshold}" Value="1">
                    <Setter Property="FontWeight" Value="Normal"/>
                    <Setter Property="Foreground" Value="Black"/>
                  </DataTrigger>
                  <DataTrigger Binding="{Binding SuccessThreshold}" Value="{x:Static sys:Int32.MaxValue}">
                    <Setter Property="FontWeight" Value="Bold"/>
                    <Setter Property="Foreground" Value="#FFCC0000"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </DataGridTextColumn.ElementStyle>
            <DataGridTextColumn.HeaderStyle>
              <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                <Setter Property="ToolTip" Value="Оценка успешности выполнения звена цепочки: -10...+10"/>
              </Style>
            </DataGridTextColumn.HeaderStyle>
          </DataGridTextColumn>

        </DataGrid.Columns>
      </DataGrid>
    </Border>

    <!-- Нижняя панель -->
    <Grid Grid.Row="3" Margin="0,0,0,0">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>

      <!-- Текст пояснения -->
      <TextBlock Grid.Column="0"
                 Text="Таблица только для чтения. Отображает связи между автоматизмами и цепочками действий."
                 Foreground="Gray"
                 FontStyle="Italic"
                 VerticalAlignment="Center"
                 TextWrapping="Wrap"/>
    </Grid>

  </Grid>
</UserControl>
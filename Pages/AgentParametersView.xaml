<UserControl x:Class="AIStudio.Pages.AgentParametersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:AIStudio.Converters"
             Height="Auto" Width="Auto">

  <UserControl.Resources>
    <!-- Конвертеры -->
    <converters:ParameterStateToBrushConverter x:Key="StateToBrushConverter"/>
    <converters:ParameterValueToGradientConverter x:Key="ValueToGradientConverter"/>
    <converters:ParameterGradientConverter x:Key="GradientConverter"/>
    <converters:ParameterValueToIndicatorPositionConverter x:Key="ValueToIndicatorConverter"/>
    <converters:ParameterStateToLightBackgroundConverter x:Key="StateToBackgroundConverter"/>

    <!-- Стили для компактного отображения -->
    <Style x:Key="ParameterContainerStyle" TargetType="Border">
      <Setter Property="Background" Value="#FFF0F0F0"/>
      <Setter Property="CornerRadius" Value="5"/>
      <Setter Property="Padding" Value="5"/>
      <Setter Property="Margin" Value="5"/>
      <Setter Property="Width" Value="200"/>
      <Setter Property="Height" Value="50"/>
    </Style>

    <Style x:Key="StateIndicatorStyle" TargetType="Ellipse">
      <Setter Property="Width" Value="10"/>
      <Setter Property="Height" Value="10"/>
      <Setter Property="Margin" Value="0,0,3,0"/>
      <Setter Property="VerticalAlignment" Value="Top"/>
      <Setter Property="HorizontalAlignment" Value="Left"/>
    </Style>

    <Style x:Key="ValueTextStyle" TargetType="TextBlock">
      <Setter Property="VerticalAlignment" Value="Top"/>
      <Setter Property="HorizontalAlignment" Value="Right"/>
      <Setter Property="FontWeight" Value="Bold"/>
      <Setter Property="FontSize" Value="11"/>
      <Setter Property="Margin" Value="0,0,3,0"/>
    </Style>

    <Style x:Key="ParameterNameStyle" TargetType="TextBlock">
      <Setter Property="VerticalAlignment" Value="Top"/>
      <Setter Property="HorizontalAlignment" Value="Left"/>
      <Setter Property="FontWeight" Value="SemiBold"/>
      <Setter Property="FontSize" Value="11"/>
      <Setter Property="Margin" Value="16,0,0,2"/>
      <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
    </Style>

    <Style x:Key="IndicatorBarStyle" TargetType="Border">
      <Setter Property="CornerRadius" Value="2"/>
      <Setter Property="Height" Value="12"/>
      <Setter Property="Margin" Value="3,2,3,0"/>
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="BorderBrush" Value="#FFCCCCCC"/>
    </Style>

    <Style x:Key="ValueIndicatorStyle" TargetType="Rectangle">
      <Setter Property="Width" Value="2"/>
      <Setter Property="Height" Value="14"/>
      <Setter Property="Fill" Value="Black"/>
      <Setter Property="VerticalAlignment" Value="Center"/>
    </Style>

  </UserControl.Resources>

  <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
    <ItemsControl ItemsSource="{Binding Parameters}">
      <ItemsControl.ItemsPanel>
        <ItemsPanelTemplate>
          <!-- Фиксируем 4 элемента в строку -->
          <WrapPanel Orientation="Horizontal" Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ScrollViewer}}"/>
        </ItemsPanelTemplate>
      </ItemsControl.ItemsPanel>

      <ItemsControl.ItemTemplate>
        <DataTemplate>
          <Border>
            <Border.Style>
              <Style TargetType="Border" BasedOn="{StaticResource ParameterContainerStyle}">
                <Style.Triggers>
                  <DataTrigger Binding="{Binding IsDominant}" Value="True">
                    <Setter Property="BorderBrush" Value="{Binding CurrentState, Converter={StaticResource StateToBrushConverter}}"/>
                    <Setter Property="BorderThickness" Value="2"/>
                    <Setter Property="Background" Value="{Binding CurrentState, Converter={StaticResource StateToBackgroundConverter}}"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </Border.Style>

            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>

              <!-- Верхняя строка - индикатор состояния, имя и значение -->
              <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Ellipse Grid.Column="0" Style="{StaticResource StateIndicatorStyle}" 
                         Fill="{Binding CurrentState, Converter={StaticResource StateToBrushConverter}}"/>
                <TextBlock Grid.Column="1" Text="{Binding Name}" Style="{StaticResource ParameterNameStyle}" 
                          HorizontalAlignment="Center" VerticalAlignment="Top" ToolTip="{Binding Description}"/>
                <TextBlock Grid.Column="2" Text="{Binding Value, StringFormat={}{0:F2}}" 
                          Style="{StaticResource ValueTextStyle}" HorizontalAlignment="Right" VerticalAlignment="Top"/>
              </Grid>

              <!-- Индикаторная полоса -->
              <Border Grid.Row="1" Style="{StaticResource IndicatorBarStyle}">
                <Grid>
                  <Rectangle RadiusX="2" RadiusY="2">
                    <Rectangle.Fill>
                      <MultiBinding Converter="{StaticResource GradientConverter}">
                        <Binding Path="NormaWell"/>
                        <Binding Path="Speed"/>
                      </MultiBinding>
                    </Rectangle.Fill>
                  </Rectangle>

                  <Rectangle Style="{StaticResource ValueIndicatorStyle}" 
                             HorizontalAlignment="Left">
                    <Rectangle.Margin>
                      <MultiBinding Converter="{StaticResource ValueToIndicatorConverter}">
                        <Binding Path="Value"/>
                        <Binding Path="NormaWell"/>
                        <Binding Path="Speed"/>
                      </MultiBinding>
                    </Rectangle.Margin>
                  </Rectangle>
                </Grid>
              </Border>
            </Grid>
          </Border>
        </DataTemplate>
      </ItemsControl.ItemTemplate>

    </ItemsControl>
  </ScrollViewer>
</UserControl>
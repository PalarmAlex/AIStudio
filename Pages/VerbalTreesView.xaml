<UserControl x:Class="AIStudio.Pages.VerbalTreesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:viewmodels="clr-namespace:AIStudio.ViewModels"
             xmlns:local="clr-namespace:AIStudio.Pages"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">

  <UserControl.Resources>
    <!-- Конвертеры -->
    <local:BoolToBoldConverter x:Key="BoolToBoldConverter"/>
    <local:SearchHighlightMultiConverter x:Key="SearchHighlightMultiConverter"/>
    <local:BoolToExpandedIconConverter x:Key="BoolToExpandedIconConverter"/>
    <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

    <!-- Шаблон для дерева слов -->
    <HierarchicalDataTemplate DataType="{x:Type viewmodels:VerbalTreesViewModel+WordNode}" 
                      ItemsSource="{Binding Children}">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="{Binding Text}" 
                   FontWeight="{Binding IsLetter, Converter={StaticResource BoolToBoldConverter}}">
          <TextBlock.Background>
            <MultiBinding Converter="{StaticResource SearchHighlightMultiConverter}">
              <Binding Path="Text"/>
              <Binding Path="DataContext.WordSearchText" 
                             RelativeSource="{RelativeSource AncestorType=UserControl}"/>
            </MultiBinding>
          </TextBlock.Background>
        </TextBlock>
        <!-- Индикатор раскрытия -->
        <TextBlock Text="{Binding IsExpanded, Converter={StaticResource BoolToExpandedIconConverter}}"
                   Margin="5,0,0,0"
                   Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}"/>
      </StackPanel>
    </HierarchicalDataTemplate>

    <!-- Шаблон для дерева фраз -->
    <HierarchicalDataTemplate DataType="{x:Type viewmodels:VerbalTreesViewModel+PhraseNode}" 
                  ItemsSource="{Binding Children}">
      <StackPanel Orientation="Horizontal">
        <TextBlock Text="{Binding Text}">
          <TextBlock.Background>
            <MultiBinding Converter="{StaticResource SearchHighlightMultiConverter}">
              <Binding Path="Text"/>
              <Binding Path="DataContext.PhraseSearchText" 
                                 RelativeSource="{RelativeSource AncestorType=UserControl}"/>
            </MultiBinding>
          </TextBlock.Background>
        </TextBlock>
        <!-- Индикатор раскрытия -->
        <TextBlock Text="{Binding IsExpanded, Converter={StaticResource BoolToExpandedIconConverter}}"
                   Margin="5,0,0,0"
                   Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}"/>
      </StackPanel>
    </HierarchicalDataTemplate>

  </UserControl.Resources>

  <Grid Margin="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>

    <!-- Заголовок -->
    <TextBlock Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
             Text="Вербальные деревья агента" 
             FontSize="18"
             FontWeight="SemiBold"
             HorizontalAlignment="Center"
             Margin="0,0,0,10"/>

    <!-- Поле ввода текста -->
    <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,0,0,10">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*"/>
        <ColumnDefinition Width="Auto"/>
      </Grid.ColumnDefinitions>

      <TextBox Grid.Column="0" 
             Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
             AcceptsReturn="True"
             VerticalScrollBarVisibility="Auto"
             MinHeight="60"
             Margin="0,0,5,0"/>

      <Button Grid.Column="1" 
            Content="Добавить"
            Command="{Binding AddTextCommand}"
            Style="{StaticResource ActionButtonStyle}"
            ToolTip="Добавить текст в словари"
            MinWidth="80"
            Height="60"/>
    </Grid>

    <!-- Настройки -->
    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" 
              Orientation="Horizontal" Margin="0,0,0,10"
              HorizontalAlignment="Center">
      <CheckBox Content="Авторитарный режим"
              IsChecked="{Binding AuthoritativeMode}"
              Margin="0,0,20,0"
              ToolTip="Сразу записать слова и фразы в словари, без выдержки в 'песочнице'"
              VerticalAlignment="Center"/>

      <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,10,0">
        <TextBlock Text="Порог подтверждения:" Margin="0,0,5,0"/>
        <TextBox Text="{Binding RecognitionThreshold, UpdateSourceTrigger=PropertyChanged}"
               Width="40"
               ToolTip="Кол-во потворов слова/фразы, прежде чем она из 'песочницы' запишется в словари"/>
      </StackPanel>

      <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
        <TextBlock Text="Макс. длина фразы:" Margin="0,0,5,0"/>
        <TextBox Text="{Binding MaxPhraseLength, UpdateSourceTrigger=PropertyChanged}"
               Width="40"
               ToolTip="Максимальная длина фразы для записи в дерево фраз - кол-во узлов-слов"/>
      </StackPanel>
    </StackPanel>

    <!-- Дерево слов -->
    <GroupBox Grid.Row="3" Grid.Column="0" Header="Дерево слов" Margin="0,0,5,0">
      <GroupBox.HeaderTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding}" 
                       FontSize="16" 
                       FontWeight="SemiBold" 
                       Foreground="Black"/>
        </DataTemplate>
      </GroupBox.HeaderTemplate>
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Панель поиска с кнопкой сброса -->
        <DockPanel Grid.Row="0" Margin="0,0,0,5" LastChildFill="True">
          <Button Content="Сброс" 
                    Command="{Binding ResetWordSearchCommand}"
                    Style="{StaticResource AgentButtonStyle}"
                    MinWidth="50"
                    DockPanel.Dock="Right"
                    Margin="5,0,0,0"
                    ToolTip="Сбросить фильтр, свернуть дерево"/>

          <Button Content="Найти" 
                    Command="{Binding SearchWordCommand}"
                    Style="{StaticResource AgentButtonStyle}"
                    MinWidth="50"
                    DockPanel.Dock="Right"
                    Margin="5,0,0,0"
                    ToolTip="Поиск слов в дереве по вхождению введенных символов в поле фильтра"/>

          <TextBox Text="{Binding WordSearchText, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"/>
        </DockPanel>

        <TreeView Grid.Row="1" x:Name="WordsTreeView" 
                  ItemsSource="{Binding VisibleWordNodes}"
                  VirtualizingStackPanel.IsVirtualizing="True"
                  VirtualizingStackPanel.VirtualizationMode="Recycling">
          <TreeView.ItemContainerStyle>
            <Style TargetType="{x:Type TreeViewItem}">
              <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
              <EventSetter Event="Expanded" Handler="WordTreeView_Expanded"/>
              <EventSetter Event="Selected" Handler="WordTreeView_Selected"/>
            </Style>
          </TreeView.ItemContainerStyle>
        </TreeView>

        <TextBlock Grid.Row="2" 
                   Text="{Binding WordsCount, StringFormat='Всего слов: {0}'}"
                   HorizontalAlignment="Right"
                   Margin="0,5,0,0"/>
      </Grid>
    </GroupBox>

    <!-- Дерево фраз -->
    <GroupBox Grid.Row="3" Grid.Column="1" Header="Дерево фраз" Margin="5,0,0,0">
      <GroupBox.HeaderTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding}" 
                       FontSize="16" 
                       FontWeight="SemiBold" 
                       Foreground="Black"/>
        </DataTemplate>
      </GroupBox.HeaderTemplate>
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
          <RowDefinition Height="*"/>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Панель поиска с кнопкой сброса -->
        <DockPanel Grid.Row="0" Margin="0,0,0,5" LastChildFill="True">
          <Button Content="Сброс" 
                    Command="{Binding ResetPhraseSearchCommand}"
                    Style="{StaticResource AgentButtonStyle}"
                    MinWidth="50"
                    DockPanel.Dock="Right"
                    Margin="5,0,0,0"
                    ToolTip="Сбросить фильтр, свернуть дерево"/>

          <Button Content="Найти" 
                    Command="{Binding SearchPhraseCommand}"
                    Style="{StaticResource AgentButtonStyle}"
                    MinWidth="50"
                    DockPanel.Dock="Right"
                    Margin="5,0,0,0"
                    ToolTip="Поиск фраз в дереве по вхождению введенных символов в поле фильтра"/>

          <TextBox Text="{Binding PhraseSearchText, UpdateSourceTrigger=PropertyChanged}"
                     VerticalContentAlignment="Center"/>
        </DockPanel>

        <TreeView Grid.Row="1" x:Name="PhrasesTreeView" 
                  ItemsSource="{Binding VisiblePhraseNodes}"
                  VirtualizingStackPanel.IsVirtualizing="True"
                  VirtualizingStackPanel.VirtualizationMode="Recycling">
          <TreeView.ItemContainerStyle>
            <Style TargetType="{x:Type TreeViewItem}">
              <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
              <EventSetter Event="Selected" Handler="PhraseTreeView_Selected"/>
            </Style>
          </TreeView.ItemContainerStyle>
        </TreeView>

        <TextBlock Grid.Row="2" 
                   Text="{Binding PhrasesCount, StringFormat='Всего фраз: {0}'}"
                   HorizontalAlignment="Right"
                   Margin="0,5,0,0"/>
      </Grid>
    </GroupBox>

     <!--Текст предупреждения--> 
    <TextBlock Grid.Row="4" Grid.Column="0"
                 Text="{Binding PulseWarningMessage}"
                 Foreground="{Binding WarningMessageColor}"
                 FontStyle="Italic"
                 VerticalAlignment="Center"
                 Margin="8,0,0,0"
                 TextWrapping="Wrap"
                 Visibility="{Binding IsEditingEnabled, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>

    <!-- Кнопки управления -->
    <StackPanel Grid.Row="4" Grid.Column="1"
              Orientation="Horizontal" HorizontalAlignment="Right">
      <Button Content="Очистить"
                Command="{Binding RemoveAllCommand}"
                IsEnabled="{Binding IsEditingEnabled}"
                Style="{StaticResource RedButtonStyle}"
                ToolTip="Удалить все данные из словарей"/>
    </StackPanel>
  </Grid>
</UserControl>
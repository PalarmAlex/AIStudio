<UserControl x:Class="AIStudio.Pages.AgentView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:AIStudio.Converters"
             xmlns:local="clr-namespace:AIStudio.Pages"
             Height="Auto" Width="Auto">

  <UserControl.Resources>
    <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
    <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
    <converters:SecondsToTimeFormatConverter x:Key="SecondsToTimeFormatConverter"/>
    <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

    <!-- Стиль для названий свойств -->
    <Style x:Key="PropertyNameStyle" TargetType="TextBlock">
      <Setter Property="HorizontalAlignment" Value="Right"/>
      <Setter Property="Margin" Value="0,0,0,5"/>
      <Setter Property="Width" Value="70"/>
    </Style>

    <!-- Стиль для значений свойств -->
    <Style x:Key="PropertyValueStyle" TargetType="FrameworkElement">
      <Setter Property="HorizontalAlignment" Value="Left"/>
      <Setter Property="MinWidth" Value="200"/>
    </Style>

    <!-- Стиль для редактируемых полей -->
    <Style x:Key="EditableFieldStyle" TargetType="TextBox" BasedOn="{StaticResource PropertyValueStyle}">
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="BorderBrush" Value="#FF7F9DB9"/>
      <Setter Property="Padding" Value="2"/>
    </Style>

    <!-- Стиль для выпадающего списка стадий -->
    <Style x:Key="StageComboBoxStyle" TargetType="ComboBox" BasedOn="{StaticResource PropertyValueStyle}">
      <Setter Property="BorderThickness" Value="1"/>
      <Setter Property="BorderBrush" Value="#FF7F9DB9"/>
      <Setter Property="Padding" Value="2"/>
      <Setter Property="IsEnabled" Value="True"/>
    </Style>

  </UserControl.Resources>

  <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
    <StackPanel Margin="5">
      <!-- 1. Заголовок агента -->
      <TextBlock Text="{Binding AgentName}"
                           Foreground="{Binding HeaderBackground}"
                           FontSize="18"
                           FontWeight="DemiBold"
                           HorizontalAlignment="Center"
                           Margin="0,2,0,2"/>

      <!-- 2. Предупреждение о пульсации/стадии -->
      <TextBlock Text="{Binding PulseWarningMessage}"
           Foreground="{Binding WarningMessageColor}"
           FontStyle="Italic"
           VerticalAlignment="Center"
           Margin="2,0,0,0"
           TextWrapping="Wrap"
           Visibility="{Binding IsEditingEnabled, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>

      <!-- 3. Свойства агента -->
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="300"/>
          <ColumnDefinition Width="370"/>
          <ColumnDefinition Width="200"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Column="0" Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,2">
          <TextBlock Text="Имя:" Style="{StaticResource PropertyNameStyle}"/>
          <TextBox Text="{Binding AgentProperties[0].Value, UpdateSourceTrigger=PropertyChanged}"
                 IsEnabled="{Binding AgentProperties[0].IsEditable}"
                 Style="{StaticResource EditableFieldStyle}"
                 MinWidth="180"/>
        </StackPanel>

        <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,2">
          <TextBlock Text="Описание:" Style="{StaticResource PropertyNameStyle}"/>
          <TextBox Text="{Binding AgentProperties[1].Value, UpdateSourceTrigger=PropertyChanged}"
                 IsEnabled="{Binding AgentProperties[1].IsEditable}"
                 Style="{StaticResource EditableFieldStyle}"
                 MinWidth="250"
                 MaxWidth="250"
                 MouseDoubleClick="DescriptionCell_DoubleClick"/>
        </StackPanel>

        <StackPanel Grid.Column="2" Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,2">
          <TextBlock Text="Стадия:" Style="{StaticResource PropertyNameStyle}"/>
          <ComboBox ItemsSource="{Binding AvailableStages}"
            SelectedValue="{Binding SelectedStage, Mode=OneWay}"
            IsEnabled="{Binding IsStageSelectionEnabled}"
            Style="{StaticResource StageComboBoxStyle}" 
            Height="22" 
            MinWidth="100"  
            VerticalAlignment="Top"
            SelectionChanged="StageComboBox_SelectionChanged"/>
        </StackPanel>

        <StackPanel Grid.Column="3" Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,2">
          <Button Content="Сохранить" 
                        Command="{Binding UpdateCommand}"
                        Style="{StaticResource ActionButtonStyle}"
                        IsEnabled="{Binding IsEditingEnabled}" Margin="0,0,0,0" Height="30" VerticalAlignment="Bottom" HorizontalAlignment="Right" Cursor="Hand"/>
        </StackPanel>

      </Grid>

      <Border Height="2" Background="{Binding HeaderBackground}" Margin="0,0,0,2"/>

      <!--Заголовок параметров -->
      <TextBlock Text="{Binding AgentBaseSost}"
               Foreground="{Binding HomeostasisStatusColor}"
               FontSize="18"
               FontWeight="DemiBold"
               HorizontalAlignment="Center"
               Margin="0,2,0,2"/>

      <local:AgentParametersView DataContext="{Binding ParametersViewModel}" Margin="0,2,0,2"/>

      <Border Height="2" Background="{Binding HeaderBackground}" Margin="0,0,0,2"/>

      <!-- Заголовок стилей реагирования -->
      <TextBlock Text="Стили реагирования агента"
                       Foreground="{Binding HeaderBackground}"
                       FontSize="18"
                       FontWeight="DemiBold"
                       HorizontalAlignment="Center"
                       Margin="0,2,0,2"/>

      <local:AgentBehaviorStylesView DataContext="{Binding BehaviorStylesViewModel}"/>

      <Border Height="2" Background="{Binding HeaderBackground}" Margin="0,0,0,2"/>

      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Column="0" Grid.Row="0" HorizontalAlignment="Right">
          <!-- Заголовок действий -->
          <TextBlock Text="Действия агента"
           Foreground="{Binding HeaderBackground}"
           FontSize="18"
           FontWeight="DemiBold"
           HorizontalAlignment="Center"
           Margin="0,2,0,2"/>
        </StackPanel>
        <StackPanel Grid.Column="1" Grid.Row="0" HorizontalAlignment="Left">
          <!-- Блок периода ожидания оценки оператора -->
          <Border x:Name="WaitingPeriodPanel"
            Background="{Binding WaitingPeriodBackground}" 
            CornerRadius="4"
            Padding="8,4"
            Margin="10,2,10,2"
            BorderBrush="{Binding WaitingPeriodBorderBrush}"
            BorderThickness="1"
            Visibility="{Binding ShowWaitingPeriod, Converter={StaticResource BoolToVisibilityConverter}}"
            Cursor="{Binding WaitingPeriodCursor, FallbackValue=Arrow}"
            ToolTip="{Binding WaitingPeriodToolTip, FallbackValue=''}">
            <Border.InputBindings>
              <MouseBinding MouseAction="LeftClick" Command="{Binding CancelWaitingPeriodCommand}"/>
            </Border.InputBindings>

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
              <TextBlock Text="⏳" FontSize="14" Margin="0,0,5,0"/>

              <TextBlock Text="{Binding WaitingPeriodText}" 
                   FontWeight="{Binding WaitingPeriodFontWeight, FallbackValue=Normal}"
                   Foreground="{Binding WaitingPeriodForeground, FallbackValue=Gray}">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding IsWaitingPeriodPulsating}" Value="True">
                        <DataTrigger.EnterActions>
                          <BeginStoryboard>
                            <Storyboard RepeatBehavior="Forever" AutoReverse="True">
                              <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                         From="0.7" To="1.0" 
                                                         Duration="0:0:0.8"/>
                            </Storyboard>
                          </BeginStoryboard>
                        </DataTrigger.EnterActions>
                        <DataTrigger.ExitActions>
                          <BeginStoryboard>
                            <Storyboard>
                              <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                         To="1.0" 
                                                         Duration="0:0:0.3"/>
                            </Storyboard>
                          </BeginStoryboard>
                        </DataTrigger.ExitActions>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style>
              </TextBlock>

              <Button Content="✕" 
                Width="20" 
                Height="20" 
                Margin="5,0,0,0"
                Padding="0"
                FontSize="10"
                FontWeight="Bold"
                Background="Transparent"
                BorderBrush="Transparent"
                Foreground="{Binding WaitingPeriodForeground, FallbackValue=Gray}"
                Cursor="Hand"
                Command="{Binding CancelWaitingPeriodCommand}"
                ToolTip="Отменить ожидание"
                Visibility="{Binding ShowCancelButton, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </StackPanel>
          </Border>
        </StackPanel>
      </Grid>


      <!-- Заголовок действий --><!--
      <TextBlock Text="Действия агента"
           Foreground="{Binding HeaderBackground}"
           FontSize="18"
           FontWeight="DemiBold"
           HorizontalAlignment="Center"
           Margin="0,2,0,2"/>-->


      <local:AgentAdaptiveActionsView DataContext="{Binding AgentAdaptiveActionsViewModel}" />

      <Border Height="2" Background="{Binding HeaderBackground}" Margin="0,2,0,2"/>

      <!-- Заголовок пульта -->
      <TextBlock Text="Пульт взаимодействия с агентом"
                       Foreground="{Binding HeaderBackground}"
                       FontSize="18"
                       FontWeight="DemiBold"
                       HorizontalAlignment="Center"
                       Margin="0,2,0,2"/>

      <local:AgentPultView DataContext="{Binding AgentPultViewModel}" />

    </StackPanel>
  </ScrollViewer>
</UserControl>